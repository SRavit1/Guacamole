<!DOCTYPE html>
<html>

<head>
    <link rel='stylesheet' href='styles.css' type='text/css'>
</head>

<title>Guna, by Paripath</title>

<body>
    <div id='sidenav'>
        <center>
        <a href="http://www.paripath.com/" target=_blank>
            <img src="ParipathLogo100x100.jpg" style="width: 80px; height: 80px;" alt="paripath.com">
        </a>
        <hr id='break' />
        <div id='icons'>
            <button id='run-button'></button>
            <button id='save-button'></button>
            <button id='exit-button' onclick="window.location.href='http://www.paripath.com'"></button>
        </div>
        <hr id='break' />
        </center>
        <!--INSERT BUTTONS HERE-->
        <div style="display: flex; justify-content: center;">
        </div>
    </div>
    <textarea id='current-file' name='file-name' readonly></textarea>
    <textarea id='editor' name='content' class='content'></textarea>
    <pre>
    <textarea readonly id='terminal'>
Guna Explorer (Community Edition), v55.18. (c) Paripath Inc.
------------------------------------------------------------

To characterize available cells/IPs:
    1. Open run.tcl.
    2. Add, Delete available cells.
    3. Click Run.
    4. See your results in main.lib.
    </textarea>
    </pre>
</body>

<script>
    /*Handling directory click*/
    var id = document.getElementById('identification').innerHTML;

    var dropdown = document.getElementsByClassName('dir');

    for (var i = 0; i < dropdown.length; i++) {
        dropdown[i].addEventListener('click', function() {
            var this_ddc = this.nextElementSibling;
            if (this_ddc == null) {
                document.getElementById('editor').value = 'NO CONTENT HERE';
            } else {
                if (this_ddc.style.display === 'block') {
                    this.classList.remove('active');
                    this_ddc.style.display = 'none';
                } else {
                    var dropdown = document.getElementsByClassName('dir');
                    for (var j = 0; j < dropdown.length; j++) {
                        dropdown[j].classList.remove('active');
                        var ind_ddc = dropdown[j].nextElementSibling;
                        if (ind_ddc != null) {
                            ind_ddc.style.display = 'none';
                        }
                    }
                    this.classList.toggle('active');
                    this_ddc.style.display = 'block';
                }
            }
        });
    }

    /*handling file click*/
    var file = document.getElementsByClassName('file');

    for (var i = 0; i < file.length; i++) {
        file[i].addEventListener('click',
            function() { 
                var name = this.name;
                save(
                    function (){
                        document.getElementById('current-file').value = name;
                        httpGetAsync('client/' + name, 
                            function (text) {
                                document.getElementById('editor').value = text;
                            }
                        );
                    }
                );
            }
        );
    }

    //Adding event listener to save button that calls function save
    document.getElementById('save-button').addEventListener('click', function() {
        save(function(){return;});
    });

    //Sends get request to server with parameters of file name and content
    // Only saves .tcl and .cfg files on the server. 
    function save(callback) { 
        var currentfile = document.getElementById('current-file').value;
        var fext = currentfile.slice((currentfile.lastIndexOf(".") - 1 >>> 0) + 2);
        if (currentfile == "" || (fext != 'cfg' && fext != 'tcl') ) {
            callback();
            return ;
        }
        var http = new XMLHttpRequest();
        http.open('POST', '/save', true);
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        var content = document.getElementById('editor').value;
        var params = currentfile;
        params += "&" + content;
        http.send(params);
        callback();
    }

    document.getElementById('exit-button').addEventListener('click', function() {
        alert ("Thank you for using Guna Explorer!");
    });

    var exited = false;

    function exit_callback(text) {
        if (exited == false) {
            document.write(text);
            alert("Thank you for using Guna Explorer!");
            exited = true;
        }
    }

    document.getElementById('run-button').addEventListener('click', function() {       
	    save(function() {
            httpGetAsync('/run/' + id,  update);
            alert("Running characterization on the server(s).");
        });
    });

    function update(text) {
        var terminal  = document.getElementById('terminal');
        terminal.value = text;
        var main_lib = '/' + id + '/main.lib' ;
        document.getElementsByClassName('file').namedItem(main_lib).click();
        if (text.includes("ENDOFFILE")==true){
            text = text.replace("ENDOFFILE", "");


            document.getElementById('editor').style.cursor = "auto";
            document.getElementById('terminal').style.cursor = "auto";
            document.getElementById('run-button').style.cursor = "auto";
            document.getElementById('run-button').disabled = false;
            document.getElementById('save-button').style.cursor = "auto";
            document.getElementById('save-button').disabled = false;
            var dropdown = document.getElementsByClassName('dir');
            for (var i = 0; i < dropdown.length; i++) {
                dropdown[i].style.cursor = "auto";
                dropdown[i].disabled=false;         
            }
            
            var file = document.getElementsByClassName('file');
            for (var i = 0; i < file.length; i++) {
                file[i].style.cursor = "auto";
                file[i].disabled=false;
            }
        } else {
            
            document.getElementById('editor').style.cursor = "wait";
            document.getElementById('terminal').style.cursor = "wait";
            document.getElementById('run-button').style.cursor = "wait";
            document.getElementById('run-button').disabled = true;
            document.getElementById('save-button').style.cursor = "wait";
            document.getElementById('save-button').disabled = true;
            var dropdown = document.getElementsByClassName('dir');
            for (var i = 0; i < dropdown.length; i++) {
                dropdown[i].style.cursor = "wait";
                dropdown[i].disabled=true;         
            }
            
            var file = document.getElementsByClassName('file');
            for (var i = 0; i < file.length; i++) {
                file[i].style.cursor = "wait";
                file[i].disabled=true;
            }
        }
    }

    function httpGetAsync(theUrl, callback) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() {
            if ((xmlHttp.readyState == 4 || xmlHttp.readyState == 3) && xmlHttp.status == 200) {
                callback(xmlHttp.responseText);
            } else {
                console.log("readyState: " + xmlHttp.readyState);
                console.log("status: " + xmlHttp.status);
            }
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous 
        xmlHttp.send(null);
    }

    // Finally show run.tcl in the editor area.
    var run_tcl = '/' + id + '/run.tcl' ;
    document.getElementsByClassName('file').namedItem(run_tcl).click()
</script>


</html>

