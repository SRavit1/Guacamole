<!DOCTYPE html>
<html>
<title>Guna Explorer</title>

<head>
    <link rel='stylesheet' href='styles.css' type='text/css'>
</head>

<body>
    <div id='sidenav'>
        <center>
            <div id='icons'>
                <button id='run-button'></button>
                <button id='save-button'></button>
                <button id='exit-button'></button>
            </div>
            <hr id='break' />
        </center>
        <!--INSERT BUTTONS HERE-->
    </div>
    <div id='header'>Workspace</div>
    <textarea id='current-file' name='file-name' readonly></textarea>
    <textarea id='display' name='content' class='content'></textarea>
</body>

</html>

<script>
    /* Handling directory click */
    var dropdown = document.getElementsByClassName('dir');

    for (var i = 0; i < dropdown.length; i++) {
        dropdown[i].addEventListener('click', function() {
            var this_ddc = this.nextElementSibling;
            if (this_ddc == null) {
                document.getElementById('display').value = 'NO CONTENT HERE';
            } else {
                if (this_ddc.style.display === 'block') {
                    this.classList.remove('active');
                    this_ddc.style.display = 'none';
                } else {
                    var dropdown = document.getElementsByClassName('dir');
                    for (var j = 0; j < dropdown.length; j++) {
                        dropdown[j].classList.remove('active');
                        var ind_ddc = dropdown[j].nextElementSibling;
                        if (ind_ddc != null) {
                            ind_ddc.style.display = 'none';
                        }
                    }
                    this.classList.toggle('active');
                    this_ddc.style.display = 'block';
                }
            }
        });
    }

    /*handling file click*/
    var file = document.getElementsByClassName('file');

    for (var i = 0; i < file.length; i++) {
        file[i].addEventListener('click',
            function() {
                save();
                var name = this.name;
                fetch("client/" + name)
                    .then(function(res) {
                        return res.text();
                    })
                    .then(function(data) {
                        document.getElementById('current-file').value = name;
                        document.getElementById('display').value = data;
                    });
            }
        );
    }

    document.getElementById('save-button').addEventListener('click', function() {
        save();
    });

    function save() {
        console.log('save');
        var http = new XMLHttpRequest();
        http.open('POST', '/save', true);
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        var params = document.getElementById('current-file').value;
        params += "&" + document.getElementById('display').value;
        http.send(params);
    }

    document.getElementById('exit-button').addEventListener('click', function() {
        httpGetAsync('/exit', exit_callback);
    });

    var exited = false;

    function exit_callback(text) {
        if (exited == false) {
            document.write(text);
            exited = true;
        }
    }

    document.getElementById('run-button').addEventListener('click', function() {
        save();
        httpGetAsync('/run', update);
    });

    function update(text) {
        var display = document.getElementById('display');
        display.value = text;
    }

    function httpGetAsync(theUrl, callback) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() {
            if ((xmlHttp.readyState == 4 || xmlHttp.readyState == 3) && xmlHttp.status == 200) {
                callback(xmlHttp.responseText);
            } else {
                console.log("readyState: " + xmlHttp.readyState);
                console.log("status: " + xmlHttp.status);
            }
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous 
        xmlHttp.send(null);
    }
</script>